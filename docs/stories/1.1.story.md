# Story 1.1: Basic Hardware Setup and Servo Control

**Epic:** Hardware Setup and Control
**Status:** Done
**Story Points:** 5
**Priority:** High

## Story Statement
As a chicken keeper, I want the system to control two servo motors for the feeding scoop mechanism so that the basic feeding sequence can be executed.

## Acceptance Criteria
1. **AC1:** Two servo motors (MG90S) are properly initialized and controlled by the ESP32-C6
2. **AC2:** Servo 1 controls scoop rotation (0° to 180° range)
3. **AC3:** Servo 2 controls scoop tilt (0° to 180° range)  
4. **AC4:** Basic feeding sequence can be executed:
   - Loading position: Servo 1 = 0°, Servo 2 = 180°
   - Dispense feed: Servo 1 = 180°, Servo 2 = 0° (hold for 3s)
   - Return to loading: Servo 1 = 0°, Servo 2 = 180° (hold for 3s)
5. **AC5:** Servo control follows the defined coding standards and uses ESP-IDF servo library

## Dev Notes

### Previous Story Insights
No previous story exists - this is the first story in the project.

### Hardware Components
- **Servos:** 2 × MG90S (0°–180° range) [Source: architecture/tech-stack.md#3]
- **Power Control:** NPN Transistor controls power to servo motors to reduce idle consumption (types: 2N2222A, BC337, S8050) [Source: architecture/tech-stack.md#3]
- **Microcontroller:** ESP32C6 with integrated support [Source: architecture/tech-stack.md#1]

### Technical Architecture
- **Framework:** Espressif IoT Development Framework (ESP-IDF) [Source: architecture/tech-stack.md#2]
- **Language:** C/C++ [Source: architecture/tech-stack.md#2]
- **RTOS:** FreeRTOS (included in ESP-IDF) [Source: architecture/tech-stack.md#2]
- **Servo Library:** espressif/servo library [Source: architecture.md#7]
- **State Machine:** Feeding component follows defined state machine with IDLE, INIT, EMPTYING, LOADING, READY states [Source: architecture.md#3.2]

### File Locations
- **Component Location:** `/components/feeding_service/` [Source: architecture/source-tree.md#1]
- **Header File:** `/components/feeding_service/include/feeding_service.h` [Source: architecture/source-tree.md#1]
- **Implementation:** `/components/feeding_service/src/feeding_service.c` [Source: architecture/source-tree.md#1]
- **Build File:** `/components/feeding_service/CMakeLists.txt` [Source: architecture/source-tree.md#1]

### Coding Standards
- **Function Naming:** `<component>_<action>()` format (e.g., `feeding_service_start_feeding()`) [Source: architecture/coding-standards.md#3]
- **Variable Naming:** `snake_case` [Source: architecture/coding-standards.md#3]
- **Constants:** `UPPER_CASE_WITH_UNDERSCORES` [Source: architecture/coding-standards.md#3]
- **Error Handling:** Use ESP-IDF error codes (`esp_err_t`) [Source: architecture/coding-standards.md#6]
- **Logging:** Use `ESP_LOGx` macros [Source: architecture/coding-standards.md#6]
- **Documentation:** Doxygen-style comments for public functions [Source: architecture/coding-standards.md#4]

### Testing Requirements
- **Unit Tests:** Planned for critical modules [Source: architecture/tech-stack.md#8]
- **Build Command:** `idf.py build flash monitor` [Source: architecture/tech-stack.md#2]

### Technical Constraints
- **Servo Specifications:** 5V MG90S class servos [Source: PRD section 5]
- **Power Management:** Support for continuous operation, power saving through transistor control [Source: architecture/tech-stack.md#3]
- **Timing Requirements:** 3-second hold times in feeding sequence [Source: PRD section 3.1]

## Project Structure Notes
- Current project has `components/feeding/` but architecture specifies `components/feeding_service/` - should align with architecture naming
- Main application file is `AutomatedChickenFeeder.c` instead of `main.c` as shown in architecture - acceptable variation
- Project already includes `espressif/servo` library in managed_components

## Tasks / Subtasks

### Task 1: Set up feeding service component structure (AC: 1, 5)
- Create `/components/feeding_service/` directory structure following source tree guidelines
- Create CMakeLists.txt with proper dependencies on espressif/servo
- Set up include and src directories with proper header guards

### Task 2: Implement basic servo initialization (AC: 1, 2, 3)
- Initialize servo library in feeding_service component
- Configure GPIO pins for both servos according to ESP32-C6 capabilities
- Implement servo calibration and range validation (0° to 180°)
- Add error handling with ESP-IDF error codes

### Task 3: Implement servo positioning functions (AC: 2, 3, 5)
- Create `feeding_service_set_rotation()` function for Servo 1 control
- Create `feeding_service_set_tilt()` function for Servo 2 control  
- Add angle validation and bounds checking
- Implement proper logging using ESP_LOG macros

### Task 4: Implement feeding sequence state machine (AC: 4, 5)
- Implement basic state machine with IDLE, INIT, EMPTYING, LOADING, READY states
- Create `feeding_service_start_feeding()` function to execute full sequence
- Add 3-second timing controls using FreeRTOS delays
- Implement sequence: Loading (0°,180°) → Dispense (180°,0°,3s) → Return (0°,180°,3s)

### Task 5: Add power management support (AC: 1)
- Research and implement NPN transistor control for servo power management
- Add servo enable/disable functions to reduce idle consumption
- Integrate power control into feeding sequence

### Task 6: Integration and testing (AC: 1, 2, 3, 4, 5)
- Integrate feeding service component with main application
- Test individual servo movements and position accuracy
- Test complete feeding sequence execution
- Verify timing requirements (3-second holds)
- Test error handling and recovery scenarios

### Task 7: Documentation and code review (AC: 5)
- Add Doxygen documentation to all public functions
- Ensure coding standards compliance (naming, formatting, error handling)
- Create component documentation file at `/docs/software/feeding_service.md`

## Definition of Done
- [ ] All acceptance criteria met and tested
- [ ] Code follows defined coding standards
- [ ] Proper error handling implemented
- [ ] Documentation completed
- [ ] Integration testing successful
- [ ] No memory leaks or resource issues identified

## Notes
This story establishes the foundational servo control capability that will be used by subsequent stories for scheduling, web interface, and sensor integration.

## Dev Agent Record
*This section will be populated by the Dev Agent during implementation*

### Implementation Notes
- 

### Challenges Encountered
- 

### Completion Notes
- 

### Debug Log References
- 